<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bookish Pop-up Inventory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
 <style>
 body { 
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 0;
    width: 100vw;
    overflow-x: hidden;
  }
  * {
    box-sizing: border-box;
  }
  video { -webkit-transform: translateZ(0); max-width: 100%; }
  .quagga-scanner { position: relative; max-width: 100%; }
  
  /* Book Cottage Color Palette */
  :root {
    --sage-green: #87A96B;
    --warm-brass: #B5651D;
    --dusty-rose: #D4A574;
    --warm-gray: #8B7D6B;
    --parchment: #F4F1E8;
    --deep-moss: #4A5D23;
    --soft-lavender: #B19CD9;
  }
  
  /* Custom color classes */
  .bg-cottage-sage { background-color: var(--sage-green); }
  .bg-cottage-brass { background-color: var(--warm-brass); }
  .bg-cottage-rose { background-color: var(--dusty-rose); }
  .bg-cottage-gray { background-color: var(--warm-gray); }
  .bg-cottage-parchment { background-color: var(--parchment); }
  .bg-cottage-moss { background-color: var(--deep-moss); }
  .bg-cottage-lavender { background-color: var(--soft-lavender); }
  
  .text-cottage-sage { color: var(--sage-green); }
  .text-cottage-brass { color: var(--warm-brass); }
  .text-cottage-rose { color: var(--dusty-rose); }
  .text-cottage-gray { color: var(--warm-gray); }
  .text-cottage-parchment { color: var(--parchment); }
  .text-cottage-moss { color: var(--deep-moss); }
  .text-cottage-lavender { color: var(--soft-lavender); }
  
  .border-cottage-sage { border-color: var(--sage-green); }
  .border-cottage-brass { border-color: var(--warm-brass); }
  .border-cottage-rose { border-color: var(--dusty-rose); }
  .border-cottage-gray { border-color: var(--warm-gray); }
  .border-cottage-parchment { border-color: var(--parchment); }
  .border-cottage-moss { border-color: var(--deep-moss); }
  .border-cottage-lavender { border-color: var(--soft-lavender); }
  
  /* Hover states */
  .hover-cottage-sage:hover { background-color: #759157; }
  .hover-cottage-brass:hover { background-color: #A04F18; }
  .hover-cottage-rose:hover { background-color: #C59968; }
  .hover-cottage-gray:hover { background-color: #7A6F60; }
  .hover-cottage-moss:hover { background-color: #3E4E1E; }
</style>
</head>
<body class="bg-cottage-parchment">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useRef, useState, useCallback } = React;

    const classNames = (...cls) => cls.filter(Boolean).join(" ");
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    // Enhanced categorization system for pop-up bookstore
    const GENRE_MAPPING = {
      // Primary genres
      'mystery': ['Mystery', 'Cozy Mystery'],
      'detective': ['Mystery', 'Detective'],
      'thriller': ['Thriller', 'Psychological Thriller'],
      'suspense': ['Suspense', 'Thriller'],
      'crime': ['Crime', 'Mystery'],
      'police': ['Crime', 'Police Procedural'],
      'cozy': ['Cozy Mystery', 'Cozy Reads'],
      
      // Romance and relationships
      'romance': ['Romance', 'Contemporary Romance'],
      'contemporary romance': ['Romance', 'Contemporary Romance'],
      'historical romance': ['Romance', 'Historical Romance', 'Historical Fiction'],
      'erotic': ['Spicy Romance', 'Adult'],
      'spicy': ['Spicy Romance', 'Adult'],
      'love story': ['Romance', 'Love Story'],
      
      // Fantasy and sci-fi
      'fantasy': ['Fantasy', 'Epic Fantasy'],
      'urban fantasy': ['Fantasy', 'Urban Fantasy', 'Paranormal'],
      'paranormal': ['Paranormal', 'Fantasy'],
      'science fiction': ['Sci-Fi', 'Space Opera'],
      'sci-fi': ['Sci-Fi'],
      'dystopian': ['Dystopian', 'Sci-Fi'],
      'post-apocalyptic': ['Post-Apocalyptic', 'Dystopian'],
      
      // Historical and literary
      'historical': ['Historical Fiction', 'Period Drama'],
      'literary': ['Literary Fiction', 'Book Club Pick'],
      'classic': ['Classic Literature', 'Timeless'],
      'historical fiction': ['Historical Fiction', 'Period Drama'],
      'period': ['Period Drama', 'Historical Fiction'],
      
      // Life and relationships
      'family': ['Family Drama', 'Multigenerational'],
      'coming of age': ['Coming of Age', 'Character Study'],
      'women\'s fiction': ['Women\'s Fiction', 'Book Club Pick'],
      'friendship': ['Friendship', 'Relationships'],
      'memoir': ['Memoir', 'Biography', 'Nonfiction'],
      'biography': ['Biography', 'Nonfiction'],
      
      // Adventure and action
      'adventure': ['Adventure', 'Action'],
      'action': ['Action', 'Thriller'],
      'war': ['War Fiction', 'Historical Fiction'],
      'military': ['Military Fiction', 'War Fiction'],
      
      // Mood and atmosphere
      'dark': ['Dark Fiction', 'Gothic'],
      'gothic': ['Gothic', 'Atmospheric'],
      'atmospheric': ['Atmospheric', 'Mood'],
      'heartwarming': ['Heartwarming', 'Feel-Good'],
      'uplifting': ['Uplifting', 'Feel-Good'],
      'emotional': ['Emotional', 'Tearjerker'],
      
      // Special categories
      'young adult': ['YA', 'Coming of Age'],
      'ya': ['YA'],
      'teen': ['YA', 'Teen'],
      'nonfiction': ['Nonfiction'],
      'self-help': ['Self-Help', 'Personal Development'],
      'humor': ['Humor', 'Comedy'],
      'comedy': ['Comedy', 'Humor']
    };

    const BLIND_DATE_THEMES = [
      'Hidden gem from lesser-known author',
      'Unexpected plot twist you won\'t see coming',
      'Set in an exotic, faraway location',
      'Strong female protagonist who defies expectations',
      'Atmospheric read perfect for cozy evenings',
      'Emotional journey that will stay with you',
      'Genre-bending story that\'s hard to categorize',
      'Underrated book that deserves more recognition',
      'Perfect escape from everyday life',
      'Thought-provoking with deeper meaning'
    ];

    function estimateReadingTime(pages) {
      if (!pages || pages <= 0) return { hours: null, pace: "Unknown" };
      const words = pages * 275;
      const hours = Math.round(((words / 225) / 60) * 10) / 10;
      let pace;
      if (pages < 250) pace = "Quick Read";
      else if (pages <= 350) pace = "Standard";
      else if (pages <= 500) pace = "Immersive";
      else pace = "Epic Journey";
      return { hours, pace };
    }

function enhancedTagging(categories = [], description = '', title = '') {
  const text = `${categories.join(' ')} ${description} ${title}`.toLowerCase();
  const tags = new Set();
  
  // Enhanced setting analysis
  if (text.includes('new york') || text.includes('manhattan') || text.includes('brooklyn')) tags.add('Set in NYC');
  if (text.includes('small town') || text.includes('hometown') || text.includes('rural')) tags.add('Small Town');
  if (text.includes('victorian') || text.includes('regency') || text.includes('1800s')) tags.add('Historical Setting');
  if (text.includes('paris') || text.includes('london') || text.includes('italy')) tags.add('International Setting');
  if (text.includes('college') || text.includes('university') || text.includes('campus')) tags.add('Academic Setting');
  
  // Enhanced character analysis
  if (text.includes('strong woman') || text.includes('fierce heroine') || text.includes('independent woman')) tags.add('Strong Female Lead');
  if (text.includes('enemies to lovers') || text.includes('hate to love') || text.includes('rivals')) tags.add('Enemies to Lovers');
  if (text.includes('found family') || text.includes('chosen family')) tags.add('Found Family');
  if (text.includes('lgbtq') || text.includes('queer') || text.includes('gay') || text.includes('lesbian')) tags.add('LGBTQ+');
  
  // Enhanced mood/pace analysis
  if (text.includes('slow burn') || text.includes('gradual') || text.includes('slowly develops')) tags.add('Slow Burn');
  if (text.includes('fast-paced') || text.includes('thrilling') || text.includes('page-turner')) tags.add('Fast-Paced');
  if (text.includes('cozy') || text.includes('comfort') || text.includes('heartwarming')) tags.add('Cozy Read');
  if (text.includes('dark') || text.includes('gritty') || text.includes('disturbing')) tags.add('Dark Themes');
  if (text.includes('funny') || text.includes('hilarious') || text.includes('witty')) tags.add('Humor');
  if (text.includes('emotional') || text.includes('tearjerker') || text.includes('cry')) tags.add('Emotional');
  
  // Enhanced plot/structure analysis
  if (text.includes('twist') || text.includes('surprise') || text.includes('unexpected')) tags.add('Plot Twists');
  if (text.includes('multiple perspectives') || text.includes('dual timeline') || text.includes('alternating')) tags.add('Multiple POV');
  if (text.includes('epistolary') || text.includes('letters') || text.includes('diary')) tags.add('Unique Format');
  
  // Apply original genre mapping
  for (const [keyword, genreTags] of Object.entries(GENRE_MAPPING)) {
    if (text.includes(keyword)) {
      genreTags.forEach(tag => tags.add(tag));
    }
  }
  
  // Add special descriptive tags
  if (text.includes('award') || text.includes('winner') || text.includes('bestseller')) {
    tags.add('Award Winner');
  }
  if (text.includes('series') || text.includes('book 1') || text.includes('first in')) {
    tags.add('Series Starter');
  }
  if (text.includes('standalone')) {
    tags.add('Standalone');
  }
  
  return Array.from(tags);
}

    function suggestBlindDateTheme(book) {
      const themes = [];
      const text = `${book.description || ''} ${(book.categories || []).join(' ')}`.toLowerCase();
      const rating = book.averageRating || 0;
      const popularity = book.ratingsCount || 0;
      
      if (popularity < 1000) themes.push('Hidden gem from lesser-known author');
      if (text.includes('twist') || text.includes('surprise')) themes.push('Unexpected plot twist you won\'t see coming');
      if (text.includes('japan') || text.includes('india') || text.includes('africa') || text.includes('exotic')) {
        themes.push('Set in an exotic, faraway location');
      }
      if (text.includes('woman') || text.includes('female') || text.includes('heroine')) {
        themes.push('Strong female protagonist who defies expectations');
      }
      if (text.includes('atmospheric') || text.includes('cozy') || text.includes('winter')) {
        themes.push('Atmospheric read perfect for cozy evenings');
      }
      if (rating >= 4.2) themes.push('Emotional journey that will stay with you');
      if (popularity < 500 && rating >= 4.0) themes.push('Underrated book that deserves more recognition');
      
      return themes.length > 0 ? themes[0] : BLIND_DATE_THEMES[Math.floor(Math.random() * BLIND_DATE_THEMES.length)];
    }

    function isGoodBlindDateCandidate(book, purchaseCost) {
      const cost = parseFloat(purchaseCost) || 0;
      const rating = book.averageRating || 0;
      const popularity = book.ratingsCount || 0;
      const hasDescription = (book.description || '').length > 100;
      
      // Good candidates: decent rating, not too popular, interesting description, cheap acquisition
      return (
        rating >= 3.5 && 
        rating <= 4.3 && 
        popularity > 10 && 
        popularity < 2000 && 
        hasDescription && 
        cost <= 3.0
      );
    }

    function csvEscape(v) {
      if (v === null || v === undefined) return "";
      const s = String(v);
      return (s.includes(',') || s.includes('\n') || s.includes('"')) ? '"' + s.replaceAll('"', '""') + '"' : s;
    }

    function exportForClaude(inventory) {
      const summary = {
        totalBooks: inventory.length,
        availableBooks: inventory.filter(b => !b.sold).length,
        soldBooks: inventory.filter(b => b.sold).length,
        blindDateCandidates: inventory.filter(b => b.blindDateCandidate && !b.sold).length,
        tagCounts: {},
        bucketCounts: {},
        averageRating: 0,
        topAuthors: {},
        recentAdditions: inventory.slice(0, 10)
      };

      // Count tags and buckets
      inventory.forEach(book => {
        if (!book.sold) {
          (book.tags || []).forEach(tag => {
            summary.tagCounts[tag] = (summary.tagCounts[tag] || 0) + 1;
          });
          if (book.bucketColor) {
            summary.bucketCounts[book.bucketColor] = (summary.bucketCounts[book.bucketColor] || 0) + 1;
          }
        }
        
        // Count authors
        (book.authors || []).forEach(author => {
          summary.topAuthors[author] = (summary.topAuthors[author] || 0) + 1;
        });
      });

      // Calculate average rating
      const ratedBooks = inventory.filter(b => b.averageRating && !b.sold);
      if (ratedBooks.length > 0) {
        summary.averageRating = ratedBooks.reduce((sum, b) => sum + b.averageRating, 0) / ratedBooks.length;
      }

      // Sort and limit results
      summary.tagCounts = Object.fromEntries(
        Object.entries(summary.tagCounts).sort(([,a], [,b]) => b - a).slice(0, 15)
      );
      summary.topAuthors = Object.fromEntries(
        Object.entries(summary.topAuthors).sort(([,a], [,b]) => b - a).slice(0, 10)
      );

      return JSON.stringify(summary, null, 2);
    }

    function saveFile(name, content) {
      const blob = new Blob([content], { type: "text/plain;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = name; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // Enhanced barcode scanner using QuaggaJS as fallback
    function EnhancedBarcodeScanner({ onDetected }) {
      const videoRef = useRef(null);
      const scannerRef = useRef(null);
      const [supported, setSupported] = useState(false);
      const [active, setActive] = useState(false);
      const [error, setError] = useState("");
      const [useQuagga, setUseQuagga] = useState(false);

      useEffect(() => {
        setSupported('BarcodeDetector' in window || typeof Quagga !== 'undefined');
        setUseQuagga(!('BarcodeDetector' in window) && typeof Quagga !== 'undefined');
      }, []);

      const stopScanning = useCallback(() => {
        if (useQuagga && typeof Quagga !== 'undefined') {
          try {
            Quagga.stop();
          } catch (e) {
            console.warn('Error stopping Quagga:', e);
          }
        }
        if (videoRef.current && videoRef.current.srcObject) {
          videoRef.current.srcObject.getTracks().forEach(track => track.stop());
          videoRef.current.srcObject = null;
        }
      }, [useQuagga]);

      useEffect(() => {
        if (!active) {
          stopScanning();
          return;
        }

        setError("");

        if (useQuagga && typeof Quagga !== 'undefined') {
          // Use QuaggaJS fallback
          Quagga.init({
            inputStream: {
              name: "Live",
              type: "LiveStream",
              target: scannerRef.current,
              constraints: {
                width: 640,
                height: 480,
                facingMode: "environment"
              }
            },
            decoder: {
              readers: ["ean_reader", "ean_8_reader", "code_128_reader"]
            }
          }, (err) => {
            if (err) {
              setError(err.message || String(err));
              setActive(false);
              return;
            }
            Quagga.start();
          });

          Quagga.onDetected((data) => {
            if (data && data.codeResult && data.codeResult.code) {
              onDetected(data.codeResult.code);
              setActive(false);
            }
          });

          return () => stopScanning();
        } else if ('BarcodeDetector' in window) {
          // Use native BarcodeDetector
          let stream, rafId, detector;
          
          (async () => {
            try {
              detector = new window.BarcodeDetector({ 
                formats: ['ean_13','ean_8','upc_e','upc_a','code_128'] 
              });
              stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, 
                audio: false 
              });
              
              if (videoRef.current) { 
                videoRef.current.srcObject = stream; 
                await videoRef.current.play(); 
              }

              const scan = async () => {
                try {
                  if (videoRef.current?.readyState === 4) {
                    const detections = await detector.detect(videoRef.current);
                    const code = detections?.[0]?.rawValue;
                    if (code) { 
                      onDetected(code); 
                      setActive(false); 
                      return; 
                    }
                  }
                } catch (e) {
                  console.warn('Detection error:', e);
                }
                rafId = requestAnimationFrame(scan);
              };
              scan();
            } catch (e) { 
              setError(e.message || String(e)); 
              setActive(false); 
            }
          })();

          return () => {
            if (rafId) cancelAnimationFrame(rafId);
            stopScanning();
          };
        }
      }, [active, onDetected, useQuagga, stopScanning]);

      return (
        <div className="w-full max-w-full">
          <div className="flex items-center gap-2 mb-3">
            <button 
              onClick={() => setActive(a => !a)} 
              className={classNames(
                "px-4 py-2 rounded-lg shadow font-medium",
                active ? "bg-red-600 text-white" : "bg-green-600 text-white"
              )}
            >
              {active ? "Stop Scanner" : "Start Scanner"}
            </button>
            {!supported && (
              <span className="text-sm text-red-600">
                Barcode scanning not supported. Please use manual ISBN lookup.
              </span>
            )}
            {useQuagga && (
              <span className="text-xs text-blue-600">Using fallback scanner</span>
            )}
          </div>
          
          <div className="rounded-lg shadow-lg bg-black max-w-full">
  {useQuagga ? (
    <div ref={scannerRef} className="w-full h-64 max-w-full" />
  ) : (
    <video ref={videoRef} className="w-full h-64 object-cover max-w-full" muted playsInline />
  )}
</div>
          
          {error && <p className="text-sm text-red-600 mt-2">{error}</p>}
        </div>
      );
    }

    // API functions with better error handling
    async function fetchWithRetry(url, retries = 3) {
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url);
          if (response.ok) return response;
          if (response.status === 429) {
            // Rate limited, wait and retry
            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
            continue;
          }
          throw new Error(`HTTP ${response.status}`);
        } catch (error) {
          if (i === retries - 1) throw error;
          await new Promise(resolve => setTimeout(resolve, 500));
        }
      }
    }

    async function fetchByISBN(isbn) {
      const cleaned = (isbn || "").replace(/[^0-9Xx]/g, "");
      if (!cleaned) return null;
      
      try {
        const gRes = await fetchWithRetry(`https://www.googleapis.com/books/v1/volumes?q=isbn:${cleaned}`);
        const gJson = await gRes.json();
        if (gJson && Array.isArray(gJson.items) && gJson.items.length) {
          return normalizeGoogleVolume(gJson.items[0]);
        }
      } catch (error) {
        console.warn('Google Books API error:', error);
      }
      
      try {
        const oRes = await fetchWithRetry(`https://openlibrary.org/isbn/${cleaned}.json`);
        const data = await oRes.json();
        return normalizeOpenLibraryISBN(data, cleaned);
      } catch (error) {
        console.warn('OpenLibrary API error:', error);
      }
      
      return null;
    }

    async function fetchByTitle(query) {
      const q = encodeURIComponent(query || "");
      if (!q) return [];
      
      try {
        const gRes = await fetchWithRetry(`https://www.googleapis.com/books/v1/volumes?q=intitle:${q}&maxResults=10`);
        const gJson = await gRes.json();
        const items = [];
        if (gJson && Array.isArray(gJson.items)) {
          for (const vol of gJson.items) {
            const normalized = normalizeGoogleVolume(vol);
            if (normalized) items.push(normalized);
          }
        }
        return items;
      } catch (error) {
        console.warn('Title search error:', error);
        return [];
      }
    }

    function parseIndustryIdentifiers(arr) {
      const out = { isbn10: null, isbn13: null };
      if (!Array.isArray(arr)) return out;
      for (const id of arr) {
        if (!id || !id.type) continue;
        if (id.type.includes("ISBN_13")) out.isbn13 = id.identifier;
        if (id.type.includes("ISBN_10")) out.isbn10 = id.identifier;
      }
      return out;
    }

    function normalizeGoogleVolume(vol) {
      if (!vol || !vol.volumeInfo) return null;
      const v = vol.volumeInfo;
      const sale = vol.saleInfo || {};
      const ids = parseIndustryIdentifiers(v.industryIdentifiers);
      const price = sale?.listPrice?.amount ? `${sale.listPrice.amount} ${sale.listPrice.currencyCode || ""}`.trim() : null;
      
      return {
        source: "GoogleBooks",
        title: v.title || "",
        authors: v.authors || [],
        publisher: v.publisher || "",
        publishedDate: v.publishedDate || "",
        pageCount: v.pageCount || null,
        categories: v.categories || [],
        averageRating: v.averageRating || null,
        ratingsCount: v.ratingsCount || null,
        thumbnail: v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || null,
        description: v.description || "",
        isbn10: ids.isbn10,
        isbn13: ids.isbn13,
        listPrice: price,
      };
    }

    function normalizeOpenLibraryISBN(data, isbn) {
      if (!data) return null;
      return {
        source: "OpenLibrary",
        title: data.title || "",
        authors: [],
        publisher: Array.isArray(data.publishers) ? data.publishers.join(", ") : "",
        publishedDate: data.publish_date || "",
        pageCount: data.number_of_pages || null,
        categories: [],
        averageRating: null,
        ratingsCount: null,
        thumbnail: data.covers?.length ? `https://covers.openlibrary.org/b/id/${data.covers[0]}-M.jpg` : null,
        description: typeof data.description === 'string' ? data.description : (data.description?.value || ""),
        isbn10: isbn?.length === 10 ? isbn : null,
        isbn13: isbn?.length === 13 ? isbn : null,
        listPrice: null,
      };
    }

    function useLocalStorage(key, initial) {
      const [state, setState] = useState(() => {
        try { 
          const raw = localStorage.getItem(key); 
          return raw ? JSON.parse(raw) : initial; 
        } catch { 
          return initial; 
        }
      });
      
      useEffect(() => { 
        try { 
          localStorage.setItem(key, JSON.stringify(state)); 
        } catch (error) {
          console.warn('localStorage error:', error);
        } 
      }, [key, state]);
      
      return [state, setState];
    }

    const DEFAULT_BUCKETS = [
  { color: "green", label: "Browse & Go ($2)", price: 2 },
  { color: "blue", label: "Solid Picks ($4)", price: 4 },
  { color: "purple", label: "Curated Finds ($6)", price: 6 },
  { color: "brass", label: "Blind Date ($9)", price: 9 },
  { color: "gray", label: "Spotlight ($12)", price: 12 },
];

    function suggestBucket(book, buckets) {
  // Check if it's a children's book first
  const text = `${(book.categories || []).join(' ')} ${book.description || ''} ${book.title}`.toLowerCase();
  if (text.includes('children') || text.includes('juvenile') || text.includes('picture book') || 
      text.includes('young readers') || text.includes('ages 3') || text.includes('ages 4') || 
      text.includes('ages 5') || text.includes('ages 6') || text.includes('ages 7') || text.includes('ages 8') ||
      text.includes('kindergarten') || text.includes('elementary') || text.includes('board book')) {
    // Return the "Browse & Go" bucket for all children's books
    return buckets[0] || { color: "green", label: "Browse & Go ($2)", price: 2 };
  }

  const priceList = (book.listPrice || "").match(/([0-9]+(?:\.[0-9]+)?)/);
  const msrp = priceList ? parseFloat(priceList[1]) : null;
  const year = (book.publishedDate || "").slice(0,4);
  const recent = year && parseInt(year) >= 2020;
  const rating = book.averageRating || 0;
  const popularity = book.ratingsCount || 0;
  const strong = rating >= 4.0 && popularity > 1000;
  const exceptional = rating >= 4.3 && popularity > 5000;
  
  let bucketIndex = 0; // Green $2 (Browse & Go)
  
  // Basic quality indicators move to Solid Picks ($4)
  if (rating >= 3.8 || popularity > 300) bucketIndex = 1;
  
  // Good books with appeal move to Curated Finds ($6)
  if (rating >= 4.0 || popularity > 1000 || recent || (msrp && msrp >= 20)) bucketIndex = 2;
  
  // Exceptional books move to Spotlight ($12)
  if (exceptional && recent && (msrp && msrp >= 25)) bucketIndex = 4;
  
  // Note: Blind Date ($9) is handled separately in the addToInventory function
  
  const safeBucketIndex = Math.min(Math.max(bucketIndex, 0), buckets.length - 1);
  return buckets[safeBucketIndex] || buckets[0];
}
    // Main App Component
    function App() {
      const [query, setQuery] = useState("");
      const [mode, setMode] = useState("isbn");
      const [loading, setLoading] = useState(false);
      const [results, setResults] = useState([]);
      const [current, setCurrent] = useState(null);
      const [inventory, setInventory] = useLocalStorage("bookish_inventory_v3", []);
      const [purchaseCost, setPurchaseCost] = useState("");
      const [condition, setCondition] = useState("Good");
      const [notes, setNotes] = useState("");
      const [buckets, setBuckets] = useLocalStorage("bookish_buckets_v3", DEFAULT_BUCKETS);
      const [view, setView] = useState("scan");
      const [filter, setFilter] = useState("");
      const [cart, setCart] = useState([]);

      async function handleLookup(q) {
        setLoading(true);
        try {
          if (mode === "isbn") {
            const item = await fetchByISBN(q || query);
            if (item) {
              setCurrent(item);
              setResults([item]);
            } else {
              setCurrent(null);
              setResults([]);
            }
          } else {
            const items = await fetchByTitle(q || query);
            setResults(items);
            setCurrent(items[0] || null);
          }
        } catch (error) {
          console.error('Search error:', error);
          setCurrent(null);
          setResults([]);
        } finally {
          setLoading(false);
        }
      }

      function handleDetected(code) {
        setMode("isbn");
        setQuery(code);
        handleLookup(code);
      }

      function addToInventory() {
        if (!current) return;
        
        const tags = enhancedTagging(current.categories, current.description, current.title);
        const bucket = suggestBucket(current, buckets);
        const blindDateCandidate = isGoodBlindDateCandidate(current, purchaseCost);
        const blindDateTheme = blindDateCandidate ? suggestBlindDateTheme(current) : null;
        
        const entry = {
          ...current,
          id: uid(),
          addedAt: new Date().toISOString(),
          purchaseCost: purchaseCost || null,
          condition: condition || null,
          notes: notes || null,
          tags,
          bucketColor: bucket.color,
          targetPrice: bucket.price,
          blindDateCandidate,
          blindDateTheme,
          sold: false,
          soldPrice: null
        };
        
        setInventory(prev => [entry, ...prev]);
        setPurchaseCost("");
        setCondition("Good");
        setNotes("");
        setCurrent(null);
        setQuery("");
        setResults([]);
      }

      function removeFromInventory(id) {
        setInventory(prev => prev.filter(item => item.id !== id));
      }

      function toggleSold(id) {
        setInventory(prev => prev.map(item => 
          item.id === id 
            ? { ...item, sold: !item.sold, soldPrice: !item.sold ? item.targetPrice : null }
            : item
        ));
      }

      function exportInventoryCSV() {
        const headers = [
          "Title", "Authors", "ISBN-13", "ISBN-10", "Tags", "Bucket Color", "Price", 
          "Purchase Cost", "Condition", "Rating", "Page Count", "Blind Date", "Theme", 
          "Sold", "Notes", "Added Date"
        ];
        
        const rows = inventory.map(book => [
          book.title,
          (book.authors || []).join("; "),
          book.isbn13 || "",
          book.isbn10 || "",
          (book.tags || []).join("; "),
          book.bucketColor,
          book.targetPrice,
          book.purchaseCost || "",
          book.condition || "",
          book.averageRating || "",
          book.pageCount || "",
          book.blindDateCandidate ? "Yes" : "No",
          book.blindDateTheme || "",
          book.sold ? "Yes" : "No",
          book.notes || "",
          new Date(book.addedAt).toLocaleDateString()
        ].map(csvEscape));
        
        const csv = [headers.join(","), ...rows.map(row => row.join(","))].join("\n");
        saveFile(`bookish_inventory_${new Date().toISOString().slice(0,10)}.csv`, csv);
      }
      function exportMasterFile() {
  const headers = [
    "Title", "Authors", "ISBN-13", "ISBN-10", "Tags", "Bucket Color", "Price", 
    "Purchase Cost", "Condition", "Rating", "Page Count", "Blind Date", "Theme", 
    "Sold", "Notes", "Added Date"
  ];
  
  const rows = inventory.map(book => [
    book.title,
    (book.authors || []).join("; "),
    book.isbn13 || "",
    book.isbn10 || "",
    (book.tags || []).join("; "),
    book.bucketColor,
    book.targetPrice,
    book.purchaseCost || "",
    book.condition || "",
    book.averageRating || "",
    book.pageCount || "",
    book.blindDateCandidate ? "Yes" : "No",
    book.blindDateTheme || "",
    book.sold ? "Yes" : "No",
    book.notes || "",
    new Date(book.addedAt).toLocaleDateString()
  ].map(csvEscape));
  
  const csv = [headers.join(","), ...rows.map(row => row.join(","))].join("\n");
  saveFile(`bookish_master.csv`, csv);
}
      
      function exportClaudeData() {
        const claudeData = exportForClaude(inventory);
        saveFile(`bookish_claude_export_${new Date().toISOString().slice(0,10)}.json`, claudeData);
      }

      const filteredInventory = inventory.filter(book => {
        if (!filter) return true;
        const searchText = filter.toLowerCase();
        return (
          book.title.toLowerCase().includes(searchText) ||
          (book.authors || []).some(author => author.toLowerCase().includes(searchText)) ||
          (book.tags || []).some(tag => tag.toLowerCase().includes(searchText)) ||
          (book.isbn13 || "").includes(searchText) ||
          (book.isbn10 || "").includes(searchText)
        );
      });

      const bucketChipClass = (color) => {
        const baseClass = "px-2 py-1 rounded-full text-xs font-medium border ";
        switch (color) {
          case 'green': return baseClass + 'bg-green-100 text-green-800 border-green-300';
          case 'blue': return baseClass + 'bg-blue-100 text-blue-800 border-blue-300';
          case 'purple': return baseClass + 'bg-purple-100 text-purple-800 border-purple-300';
          case 'black': return baseClass + 'bg-gray-800 text-white border-gray-800';
          case 'gold': return baseClass + 'bg-yellow-100 text-yellow-800 border-yellow-300';
          default: return baseClass + 'bg-gray-100 text-gray-800 border-gray-300';
        }
      };

      return (
        <div className="min-h-screen bg-slate-50 p-2 sm:p-4 overflow-x-hidden">
          <div className="max-w-6xl mx-auto w-full px-0">
            {/* Header */}
            <header className="mb-6">
              <h1 className="text-3xl font-bold text-gray-900 mb-2">
                📚 Pop-up Bookstore Inventory
              </h1>
              <p className="text-gray-600 text-sm mb-4">
                Curated book inventory system for your traveling book
                </p>
              
              {/* Navigation */}
              <nav className="flex gap-2 overflow-x-auto">
                {[
                  { key: 'scan', label: 'Scan & Add', icon: '📱' },
                  { key: 'inventory', label: 'Inventory', icon: '📚' },
                  { key: 'checkout', label: 'Sell Books', icon: '🛒' },
                  { key: 'analytics', label: 'Analytics', icon: '📊' },
                  { key: 'settings', label: 'Settings', icon: '⚙️' }
                ].map(tab => (
                  <button
                    key={tab.key}
                    onClick={() => setView(tab.key)}
                    className={classNames(
                      "flex items-center gap-2 px-4 py-2 rounded-lg font-medium whitespace-nowrap",
                      view === tab.key 
                        ? "bg-cottage-sage text-white shadow-md" 
                        : "bg-white text-cottage-moss hover:bg-cottage-parchment shadow-sm border border-cottage-gray"
                    )}
                  >
                    <span>{tab.icon}</span>
                    <span>{tab.label}</span>
                  </button>
                ))}
              </nav>
            </header>

            {/* Scan & Add View */}
            {view === 'scan' && (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="space-y-6">
                  {/* Scanner Section */}
                  <section className="bg-white rounded-xl shadow-sm p-4 max-w-full">
                    <h2 className="text-xl font-semibold mb-4 text-cottage-moss">Book Scanner</h2>
                    <EnhancedBarcodeScanner onDetected={handleDetected} />
                  </section>

                  {/* Manual Search */}
                  <section className="bg-white rounded-xl shadow-sm p-4 max-w-full">
                    <h2 className="text-xl font-semibold mb-4 text-cottage-moss">Manual Search</h2>
                    <div className="space-y-3">
                      <div className="flex gap-2">
                        <select 
                          value={mode} 
                          onChange={(e) => setMode(e.target.value)}
                          className="px-3 py-2 border border-cottage-gray rounded-lg"
                        >
                          <option value="isbn">ISBN</option>
                          <option value="title">Title</option>
                        </select>
                        <input
                          type="text"
                          value={query}
                          onChange={(e) => setQuery(e.target.value)}
                          placeholder={mode === 'isbn' ? '9780385547345' : 'Book title...'}
                          className="flex-1 px-3 py-2 border border-cottage-gray rounded-lg"
                          onKeyPress={(e) => e.key === 'Enter' && handleLookup()}
                        />
                        <button
                          onClick={() => handleLookup()}
                          disabled={loading}
                          className="px-4 py-2 bg-cottage-sage text-white rounded-lg hover-cottage-sage disabled:opacity-50"
                        >
                          {loading ? 'Searching...' : 'Search'}
                        </button>
                      </div>
                      
                      {/* Search Results */}
                      {mode === 'title' && results.length > 1 && (
                        <div className="border border-cottage-gray rounded-lg max-h-48 overflow-y-auto">
                          {results.map((result, i) => (
                            <button
                              key={i}
                              onClick={() => setCurrent(result)}
                              className={classNames(
                                "w-full text-left p-3 border-b border-cottage-gray last:border-b-0 hover:bg-cottage-parchment",
                                current === result ? "bg-cottage-parchment" : ""
                              )}
                            >
                              <div className="font-medium text-sm text-cottage-moss">{result.title}</div>
                              <div className="text-xs text-cottage-gray">
                                {result.authors.join(', ')} • {result.publishedDate}
                              </div>
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                  </section>
                </div>

                {/* Book Details & Add */}
                <div className="bg-white rounded-xl shadow-sm p-4">
                  <h2 className="text-xl font-semibold mb-4 text-cottage-moss">Book Details</h2>
                  
                  {!current && (
                    <div className="text-center py-8 text-cottage-gray">
                      <div className="text-4xl mb-2">📖</div>
                      <p>Scan a barcode or search for a book to get started</p>
                    </div>
                  )}
                  
                  {current && (
                    <div className="space-y-4">
                      <div className="flex gap-4">
                        {current.thumbnail ? (
                          <img 
                            src={current.thumbnail} 
                            alt={current.title}
                            className="w-20 h-28 object-cover rounded-lg shadow-sm"
                          />
                        ) : (
                          <div className="w-20 h-28 bg-cottage-parchment rounded-lg flex items-center justify-center">
                            <span className="text-cottage-gray text-xs">No Image</span>
                          </div>
                        )}
                        
                        <div className="flex-1 space-y-2">
                          <h3 className="font-semibold text-lg text-cottage-moss">{current.title}</h3>
                          <p className="text-cottage-gray">{current.authors.join(', ')}</p>
                          <div className="text-sm text-cottage-gray space-y-1">
                            <div>📅 {current.publishedDate} • 📖 {current.pageCount || '?'} pages</div>
                            <div>⭐ {current.averageRating || '?'}/5 ({current.ratingsCount || 0} ratings)</div>
                            <div>💰 List: {current.listPrice || 'Not available'}</div>
                            {current.categories.length > 0 && (
                              <div>🏷️ {current.categories.join(', ')}</div>
                            )}
                          </div>
                          
                          {/* Auto-generated tags preview */}
                          {current && (
                            <div className="mt-2">
                              <div className="text-xs text-cottage-gray mb-1">Suggested tags:</div>
                              <div className="flex flex-wrap gap-1">
                                {enhancedTagging(current.categories, current.description, current.title)
                                  .slice(0, 5).map(tag => (
                                  <span key={tag} className="px-2 py-1 bg-cottage-lavender text-cottage-moss text-xs rounded-full">
                                    {tag}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                      
                      {/* Pricing & Blind Date Info */}
                      <div className="bg-cottage-parchment p-4 rounded-lg">
                        <div className="grid grid-cols-2 gap-3 mb-3">
                          <div>
                            <div className="text-sm font-medium mb-1 text-cottage-moss">Suggested Bucket</div>
                            {(() => {
                              const bucket = suggestBucket(current, buckets);
                              return (
                                <span className={bucketChipClass(bucket.color)}>
                                  {bucket.label} (${bucket.price})
                                </span>
                              );
                            })()}
                          </div>
                          
                          <div>
                            <div className="text-sm font-medium mb-1 text-cottage-moss">Blind Date Candidate</div>
                            <div className="text-sm">
                              {isGoodBlindDateCandidate(current, purchaseCost) ? (
                                <span className="text-cottage-sage font-medium">✓ Yes</span>
                              ) : (
                                <span className="text-cottage-gray">✗ No</span>
                              )}
                            </div>
                          </div>
                        </div>
                        
                        {isGoodBlindDateCandidate(current, purchaseCost) && (
                          <div className="text-xs text-cottage-gray italic">
                            "{suggestBlindDateTheme(current)}"
                          </div>
                        )}
                      </div>

                      {/* Input Fields */}
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <div>
                          <label className="block text-sm font-medium text-cottage-moss mb-1">
                            Purchase Cost
                          </label>
                          <input
                            type="number"
                            step="0.01"
                            value={purchaseCost}
                            onChange={(e) => setPurchaseCost(e.target.value)}
                            placeholder="2.50"
                            className="w-full px-3 py-2 border border-cottage-gray rounded-lg"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-cottage-moss mb-1">
                            Condition
                          </label>
                          <select
                            value={condition}
                            onChange={(e) => setCondition(e.target.value)}
                            className="w-full px-3 py-2 border border-cottage-gray rounded-lg"
                          >
                            <option value="New">New</option>
                            <option value="Like New">Like New</option>
                            <option value="Very Good">Very Good</option>
                            <option value="Good">Good</option>
                            <option value="Fair">Fair</option>
                          </select>
                        </div>
                        
                        <div>
                          <label className="block text-sm font-medium text-cottage-moss mb-1">
                            Notes
                          </label>
                          <input
                            type="text"
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            placeholder="Shelf location, series info..."
                            className="w-full px-3 py-2 border border-cottage-gray rounded-lg"
                          />
                        </div>
                      </div>

                      <button
                        onClick={addToInventory}
                        className="w-full bg-cottage-moss text-white py-3 px-4 rounded-lg font-medium hover-cottage-moss transition-colors"
                      >
                        Add to Inventory
                      </button>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Inventory View */}
            {view === 'inventory' && (
              <div className="space-y-6">
                {/* Inventory Header */}
                <div className="bg-white rounded-xl shadow-sm p-4">
                  <div className="flex flex-wrap items-center justify-between gap-4">
                    <div>
                      <h2 className="text-xl font-semibold text-cottage-moss">Your Inventory</h2>
                      <p className="text-cottage-gray">
                        {inventory.length} total books • {inventory.filter(b => !b.sold).length} available • {inventory.filter(b => b.sold).length} sold
                      </p>
                    </div>
                    
                    <div className="flex gap-2">
                      <input
  type="text"
  value={filter}
  onChange={(e) => setFilter(e.target.value)}
  placeholder="Filter by title, author, tag, ISBN..."
  className="px-3 py-2 border border-cottage-gray rounded-lg w-full sm:w-64"
/>
                      <button
                        onClick={exportMasterFile}
                        className="px-4 py-2 bg-cottage-sage text-white rounded-lg hover-cottage-sage"
                      >
                        Export Master File
                      </button>
                      <button
                        onClick={exportInventoryCSV}
                        className="px-4 py-2 bg-cottage-rose text-cottage-moss rounded-lg hover-cottage-rose"
                      >
                        Export w/ Timestamp
                      </button>
                      <button
                        onClick={exportClaudeData}
                        className="px-4 py-2 bg-cottage-lavender text-cottage-moss rounded-lg hover:bg-purple-700"
                      >
                        Export for Claude
                      </button>
                    </div>
                  </div>
                </div>

                {/* Inventory Table */}
                <div className="bg-white rounded-xl shadow-sm">
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-cottage-parchment">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-cottage-moss uppercase tracking-wider">Book</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-cottage-moss uppercase tracking-wider">Tags</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-cottage-moss uppercase tracking-wider">Bucket</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-cottage-moss uppercase tracking-wider">Price</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-cottage-moss uppercase tracking-wider">Cost</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-cottage-moss uppercase tracking-wider">Status</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-cottage-moss uppercase tracking-wider">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-cottage-parchment">
                        {filteredInventory.map((book) => (
                          <tr key={book.id} className={book.sold ? "bg-cottage-parchment" : ""}>
                            <td className="px-6 py-4">
                              <div className="flex items-center">
                                {book.thumbnail ? (
                                  <img className="h-12 w-8 object-cover rounded mr-4" src={book.thumbnail} alt="" />
                                ) : (
                                  <div className="h-12 w-8 bg-cottage-parchment rounded mr-4"></div>
                                )}
                                <div>
                                  <div className="text-sm font-medium text-cottage-moss">{book.title}</div>
                                  <div className="text-sm text-cottage-gray">{book.authors.join(', ')}</div>
                                  <div className="text-xs text-cottage-gray">
                                    {book.publishedDate} • {estimateReadingTime(book.pageCount).pace}
                                    {book.averageRating && ` • ⭐${book.averageRating}`}
                                  </div>
                                </div>
                              </div>
                            </td>
                            <td className="px-6 py-4">
                              <div className="flex flex-wrap gap-1">
                                {(book.tags || []).slice(0, 3).map(tag => (
                                  <span key={tag} className="px-2 py-1 bg-cottage-parchment text-cottage-moss text-xs rounded-full">
                                    {tag}
                                  </span>
                                ))}
                                {book.tags && book.tags.length > 3 && (
                                  <span className="text-xs text-cottage-gray">+{book.tags.length - 3}</span>
                                )}
                              </div>
                            </td>
                            <td className="px-6 py-4">
                              <span className={bucketChipClass(book.bucketColor)}>
                                {book.bucketColor}
                              </span>
                              {book.blindDateCandidate && (
                                <div className="text-xs text-cottage-brass mt-1">🎁 Blind Date</div>
                              )}
                            </td>
                            <td className="px-6 py-4 text-sm text-cottage-moss">
                              ${book.targetPrice}
                            </td>
                            <td className="px-6 py-4 text-sm text-cottage-moss">
                              {book.purchaseCost ? `$${book.purchaseCost}` : '-'}
                            </td>
                            <td className="px-6 py-4">
                              <span className={classNames(
                                "px-2 inline-flex text-xs leading-5 font-semibold rounded-full",
                                book.sold 
                                  ? "bg-cottage-sage text-white" 
                                  : "bg-cottage-lavender text-cottage-moss"
                              )}>
                                {book.sold ? 'Sold' : 'Available'}
                              </span>
                            </td>
                            <td className="px-6 py-4 text-sm font-medium space-x-2">
                              <button
                                onClick={() => toggleSold(book.id)}
                                className={classNames(
                                  "text-sm px-2 py-1 rounded",
                                  book.sold 
                                    ? "text-cottage-sage hover:text-cottage-moss" 
                                    : "text-cottage-sage hover:text-cottage-moss"
                                )}
                              >
                                {book.sold ? 'Mark Available' : 'Mark Sold'}
                              </button>
                              <button
                                onClick={() => removeFromInventory(book.id)}
                                className="text-cottage-brass hover:text-cottage-gray text-sm px-2 py-1 rounded"
                              >
                                Delete
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                    
                    {filteredInventory.length === 0 && (
                      <div className="text-center py-8 text-cottage-gray">
                        <div className="text-4xl mb-2">📚</div>
                        <p>No books found matching your filter</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}

            {/* Analytics View */}
            {view === 'analytics' && (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <InventoryStats inventory={inventory} />
                <TagBreakdown inventory={inventory} />
                <BucketAnalysis inventory={inventory} buckets={buckets} />
                <BlindDateCandidates inventory={inventory} />
              </div>
            )}

            {/* Settings View */}
            {view === 'settings' && (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <BucketSettings buckets={buckets} setBuckets={setBuckets} />
                <ExportSettings inventory={inventory} />
              </div>
            )}
          </div>
        </div>
      );
    }

    // Analytics Components
    function InventoryStats({ inventory }) {
      const available = inventory.filter(b => !b.sold);
      const sold = inventory.filter(b => b.sold);
      const totalValue = available.reduce((sum, b) => sum + (b.targetPrice || 0), 0);
      const totalCost = inventory.reduce((sum, b) => sum + (parseFloat(b.purchaseCost) || 0), 0);
      const totalRevenue = sold.reduce((sum, b) => sum + (b.soldPrice || 0), 0);

      return (
        <div className="bg-white rounded-xl shadow-sm p-4">
          <h3 className="text-lg font-semibold mb-4 text-cottage-moss">Inventory Overview</h3>
          <div className="grid grid-cols-2 gap-4">
            <div className="bg-cottage-lavender p-4 rounded-lg">
              <div className="text-2xl font-bold text-cottage-moss">{available.length}</div>
              <div className="text-sm text-cottage-moss">Available Books</div>
              <div className="text-xs text-cottage-gray">${totalValue.toFixed(2)} total value</div>
            </div>
            <div className="bg-cottage-sage p-4 rounded-lg">
              <div className="text-2xl font-bold text-white">{sold.length}</div>
              <div className="text-sm text-white">Books Sold</div>
              <div className="text-xs text-white">${totalRevenue.toFixed(2)} revenue</div>
            </div>
            <div className="bg-cottage-brass p-4 rounded-lg">
              <div className="text-2xl font-bold text-white">${totalCost.toFixed(2)}</div>
              <div className="text-sm text-white">Total Investment</div>
            </div>
            <div className="bg-cottage-rose p-4 rounded-lg">
              <div className="text-2xl font-bold text-cottage-moss">
                ${(totalRevenue - totalCost).toFixed(2)}
              </div>
              <div className="text-sm text-cottage-moss">Net Profit</div>
            </div>
          </div>
        </div>
      );
    }

    function TagBreakdown({ inventory }) {
      const tagCounts = {};
      inventory.filter(b => !b.sold).forEach(book => {
        (book.tags || []).forEach(tag => {
          tagCounts[tag] = (tagCounts[tag] || 0) + 1;
        });
      });

      const topTags = Object.entries(tagCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);

      return (
        <div className="bg-white rounded-xl shadow-sm p-4">
          <h3 className="text-lg font-semibold mb-4 text-cottage-moss">Popular Tags</h3>
          <div className="space-y-2">
            {topTags.map(([tag, count]) => (
              <div key={tag} className="flex justify-between items-center">
                <span className="text-sm text-cottage-moss">{tag}</span>
                <div className="flex items-center gap-2">
                  <div className="w-24 bg-cottage-parchment rounded-full h-2">
                    <div 
                      className="bg-cottage-sage h-2 rounded-full" 
                      style={{width: `${(count / topTags[0][1]) * 100}%`}}
                    />
                  </div>
                  <span className="text-xs text-cottage-gray w-8 text-right">{count}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function BucketAnalysis({ inventory, buckets }) {
      const available = inventory.filter(b => !b.sold);
      const bucketCounts = {};
      
      buckets.forEach(bucket => bucketCounts[bucket.color] = 0);
      available.forEach(book => {
        if (book.bucketColor) bucketCounts[book.bucketColor]++;
      });

      return (
        <div className="bg-white rounded-xl shadow-sm p-4">
          <h3 className="text-lg font-semibold mb-4 text-cottage-moss">Price Bucket Distribution</h3>
          <div className="space-y-3">
            {buckets.map(bucket => {
              const count = bucketCounts[bucket.color] || 0;
              const value = count * bucket.price;
              return (
                <div key={bucket.color} className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className={`w-3 h-3 rounded-full ${bucketChipClass(bucket.color).includes('bg-cottage') ? 'bg-cottage-' + bucket.color : 'bg-gray-400'}`}></span>
                    <span className="text-sm text-cottage-moss">{bucket.label}</span>
                  </div>
                  <div className="text-right">
                    <div className="text-sm font-medium text-cottage-moss">{count} books</div>
                    <div className="text-xs text-cottage-gray">${value.toFixed(2)} value</div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function BlindDateCandidates({ inventory }) {
      const candidates = inventory.filter(b => b.blindDateCandidate && !b.sold);

      return (
        <div className="bg-white rounded-xl shadow-sm p-4">
          <h3 className="text-lg font-semibold mb-4 text-cottage-moss">Blind Date Books ({candidates.length})</h3>
          <div className="space-y-3 max-h-64 overflow-y-auto">
            {candidates.slice(0, 10).map(book => (
              <div key={book.id} className="border-l-4 border-cottage-brass pl-3 py-2">
                <div className="font-medium text-sm text-cottage-moss">{book.title}</div>
                <div className="text-xs text-cottage-gray">{book.authors.join(', ')}</div>
                <div className="text-xs text-cottage-brass italic mt-1">
                  "{book.blindDateTheme}"
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    // Settings Components
    function BucketSettings({ buckets, setBuckets }) {
      const [editingBuckets, setEditingBuckets] = useState(buckets);

      const updateBucket = (index, field, value) => {
        setEditingBuckets(prev => prev.map((bucket, i) => 
          i === index ? { ...bucket, [field]: value } : bucket
        ));
      };

      const saveBuckets = () => {
        setBuckets(editingBuckets);
      };

      const resetBuckets = () => {
        setEditingBuckets(DEFAULT_BUCKETS);
      };

      return (
        <div className="bg-white rounded-xl shadow-sm p-4">
          <h3 className="text-lg font-semibold mb-4 text-cottage-moss">Price Buckets</h3>
          <div className="space-y-3">
            {editingBuckets.map((bucket, index) => (
              <div key={index} className="grid grid-cols-3 gap-3 items-center">
                <input
                  value={bucket.color}
                  onChange={(e) => updateBucket(index, 'color', e.target.value)}
                  className="px-3 py-2 border border-cottage-gray rounded-lg"
                  placeholder="Color"
                />
                <input
                  value={bucket.label}
                  onChange={(e) => updateBucket(index, 'label', e.target.value)}
                  className="px-3 py-2 border border-cottage-gray rounded-lg"
                  placeholder="Label"
                />
                <input
                  type="number"
                  step="0.01"
                  value={bucket.price}
                  onChange={(e) => updateBucket(index, 'price', parseFloat(e.target.value))}
                  className="px-3 py-2 border border-cottage-gray rounded-lg"
                  placeholder="Price"
                />
              </div>
            ))}
          </div>
          <div className="flex gap-2 mt-4">
            <button
              onClick={saveBuckets}
              className="px-4 py-2 bg-cottage-sage text-white rounded-lg hover-cottage-sage"
            >
              Save Changes
            </button>
            <button
              onClick={resetBuckets}
              className="px-4 py-2 bg-cottage-gray text-white rounded-lg hover:bg-cottage-gray"
            >
              Reset to Default
            </button>
          </div>
        </div>
      );
    }

    function ExportSettings({ inventory }) {
      const exportClaudePrompt = () => {
        const claudeData = exportForClaude(inventory);
        const prompt = `Here's my current bookstore inventory data:

${claudeData}

Please help me with:
1. Suggest themed groupings for my pop-up display tables
2. Create display cards with catchy descriptions for each group
3. Recommend which books might work well together
4. Identify any gaps in my current selection

Focus on creating an engaging customer experience with groupings like "Cozy Winter Reads," "Strong Heroines," "Unexpected Twists," etc.`;
        
        saveFile(`claude_prompt_${new Date().toISOString().slice(0,10)}.txt`, prompt);
      };

      return (
        <div className="bg-white rounded-xl shadow-sm p-4">
          <h3 className="text-lg font-semibold mb-4 text-cottage-moss">Export Options</h3>
          <div className="space-y-3">
            <button
              onClick={() => exportInventoryCSV()}
              className="w-full px-4 py-2 bg-cottage-sage text-white rounded-lg hover-cottage-sage"
            >
              Export Full Inventory CSV
            </button>
            <button
              onClick={() => exportClaudeData()}
              className="w-full px-4 py-2 bg-cottage-lavender text-cottage-moss rounded-lg hover:bg-purple-700"
            >
              Export Summary for Claude
            </button>
            <button
              onClick={exportClaudePrompt}
              className="w-full px-4 py-2 bg-cottage-brass text-white rounded-lg hover-cottage-brass"
            >
              Generate Claude Consultation Prompt
            </button>
          </div>
          <p className="text-sm text-cottage-gray mt-3">
            The Claude consultation prompt includes your inventory summary and asks for 
            display grouping suggestions, marketing copy, and curation recommendations.
          </p>
        </div>
      );
    }

    function bucketChipClass(color) {
      switch ((color||'').toLowerCase()) {
        case 'sage': return 'bg-cottage-sage text-white border-cottage-sage';
        case 'rose': return 'bg-cottage-rose text-cottage-moss border-cottage-rose';
        case 'lavender': return 'bg-cottage-lavender text-cottage-moss border-cottage-lavender';
        case 'gray': return 'bg-cottage-gray text-white border-cottage-gray';
        case 'brass': return 'bg-cottage-brass text-white border-cottage-brass';
        default: return 'bg-gray-100 text-gray-800 border-gray-300';
      }
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
