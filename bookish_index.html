<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bookish Inventory</title>
  <!-- Tailwind (CDN for quick start) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM + Babel (so we can run JSX without a build step) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    video { -webkit-transform: translateZ(0); }
  </style>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useRef, useState } = React;

    const classNames = (...cls) => cls.filter(Boolean).join(" ");
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    function estimateReadingTime(pages) {
      if (!pages || pages <= 0) return { hours: null, pace: "Unknown" };
      const words = pages * 275;
      const hours = Math.round(((words / 225) / 60) * 10) / 10;
      let pace = pages < 280 ? "Quick" : (pages <= 420 ? "Moderate" : "Immersive");
      return { hours, pace };
    }

    function csvEscape(v) {
      if (v === null || v === undefined) return "";
      const s = String(v);
      return (s.includes(',') || s.includes('\n') || s.includes('"')) ? '"' + s.replaceAll('"', '""') + '"' : s;
    }

    function toCSV(rows) {
      const headers = [
        "addedAt","id","title","authors","isbn_10","isbn_13","publisher","publishedDate","pageCount","estimatedHours","paceTag","categories","tags","averageRating","ratingsCount","thumbnail","listPrice","bucketColor","targetPrice","purchaseCost","condition","blindDateCandidate","sold","soldPrice","notes",
      ];
      const lines = [headers.join(",")];
      for (const r of rows) {
        const est = estimateReadingTime(r.pageCount);
        const vals = [
          r.addedAt ?? "",
          r.id ?? "",
          r.title ?? "",
          (r.authors || []).join("; "),
          r.isbn10 ?? "",
          r.isbn13 ?? "",
          r.publisher ?? "",
          r.publishedDate ?? "",
          r.pageCount ?? "",
          est.hours ?? "",
          est.pace ?? "",
          (r.categories || []).join("; "),
          (r.tags || []).join("; "),
          r.averageRating ?? "",
          r.ratingsCount ?? "",
          r.thumbnail ?? "",
          r.listPrice ?? "",
          r.bucketColor ?? "",
          r.targetPrice ?? "",
          r.purchaseCost ?? "",
          r.condition ?? "",
          r.blindDateCandidate ? "yes" : "no",
          r.sold ? "yes" : "no",
          r.soldPrice ?? "",
          r.notes ?? "",
        ].map(csvEscape);
        lines.push(vals.join(","));
      }
      return lines.join("\n");
    }

    function saveFile(name, content) {
      const blob = new Blob([content], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = name; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    function parseIndustryIdentifiers(arr) {
      const out = { isbn10: null, isbn13: null };
      if (!Array.isArray(arr)) return out;
      for (const id of arr) {
        if (!id || !id.type) continue;
        if (id.type.includes("ISBN_13")) out.isbn13 = id.identifier;
        if (id.type.includes("ISBN_10")) out.isbn10 = id.identifier;
      }
      return out;
    }

    async function fetchByISBN(isbn) {
      const cleaned = (isbn || "").replace(/[^0-9Xx]/g, "");
      if (!cleaned) return null;
      try {
        const gRes = await fetch(\`https://www.googleapis.com/books/v1/volumes?q=isbn:\${cleaned}\`);
        const gJson = await gRes.json().catch(() => ({}));
        if (gJson && Array.isArray(gJson.items) && gJson.items.length) {
          return normalizeGoogleVolume(gJson.items[0]);
        }
      } catch {}
      try {
        const oRes = await fetch(\`https://openlibrary.org/isbn/\${cleaned}.json\`);
        if (oRes.ok) {
          const data = await oRes.json();
          return normalizeOpenLibraryISBN(data, cleaned);
        }
      } catch {}
      return null;
    }

    async function fetchByTitle(query) {
      const q = encodeURIComponent(query || "");
      if (!q) return [];
      const gRes = await fetch(\`https://www.googleapis.com/books/v1/volumes?q=intitle:\${q}&maxResults=10\`);
      const gJson = await gRes.json().catch(() => ({}));
      const items = [];
      if (gJson && Array.isArray(gJson.items)) {
        for (const vol of gJson.items) items.push(normalizeGoogleVolume(vol));
      }
      return items.filter(Boolean);
    }

    function normalizeGoogleVolume(vol) {
      const v = vol?.volumeInfo || {};
      const sale = vol?.saleInfo || {};
      const ids = parseIndustryIdentifiers(v.industryIdentifiers);
      const price = sale?.listPrice?.amount ? \`\${sale.listPrice.amount} \${sale.listPrice.currencyCode || ""}\`.trim() : null;
      return {
        source: "GoogleBooks",
        title: v.title || "",
        authors: v.authors || [],
        publisher: v.publisher || "",
        publishedDate: v.publishedDate || "",
        pageCount: v.pageCount || null,
        categories: v.categories || [],
        averageRating: v.averageRating || null,
        ratingsCount: v.ratingsCount || null,
        thumbnail: v.imageLinks?.thumbnail || v.imageLinks?.smallThumbnail || null,
        description: v.description || "",
        isbn10: ids.isbn10,
        isbn13: ids.isbn13,
        listPrice: price,
      };
    }

    function normalizeOpenLibraryISBN(data, isbn) {
      return {
        source: "OpenLibrary",
        title: data?.title || "",
        authors: [],
        publisher: Array.isArray(data?.publishers) ? data.publishers.join(", ") : "",
        publishedDate: data?.publish_date || "",
        pageCount: data?.number_of_pages || null,
        categories: [],
        averageRating: null,
        ratingsCount: null,
        thumbnail: data?.covers?.length ? \`https://covers.openlibrary.org/b/id/\${data.covers[0]}-M.jpg\` : null,
        description: typeof data?.description === 'string' ? data.description : (data?.description?.value || ""),
        isbn10: isbn?.length === 10 ? isbn : null,
        isbn13: isbn?.length === 13 ? isbn : null,
        listPrice: null,
      };
    }

    function useLocalStorage(key, initial) {
      const [state, setState] = useState(() => {
        try { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : initial; } catch { return initial; }
      });
      useEffect(() => { try { localStorage.setItem(key, JSON.stringify(state)); } catch {} }, [key, state]);
      return [state, setState];
    }

    const A_LIST_AUTHORS = new Set([
      "James Patterson","Lee Child","Michael Connelly","Gillian Flynn","Ruth Ware","Stephen King","Harlan Coben","John Grisham","Tana French","Robert Galbraith","Patricia Cornwell","Louise Penny","Karin Slaughter","David Baldacci","Dan Brown"
    ]);

    const DEFAULT_BUCKETS = [
      { color: "gold", label: "Gold (Blind-Date)", price: 10 },
      { color: "green", label: "Forest Green", price: 4 },
      { color: "blue", label: "Blue", price: 5 },
      { color: "purple", label: "Purple", price: 8 },
      { color: "black", label: "Black", price: 10 },
    ];

    function normalizeTags(categories = []) {
      const raw = categories.join("; ").toLowerCase();
      const tags = new Set();
      const map = [
        ["mystery", "Mystery"],["thriller", "Thriller"],["suspense", "Suspense"],["detective", "Mystery"],["crime", "Crime"],
        ["romance", "Romance"],["erotic", "Spicy"],["spicy", "Spicy"],["fantasy", "Fantasy"],["science fiction", "Sci‚ÄëFi"],["sci-fi", "Sci‚ÄëFi"],
        ["historical", "Historical"],["young adult", "YA"],["adventure", "Adventure"],["nonfiction", "Nonfiction"],
      ];
      for (const [needle, tag] of map) if (raw.includes(needle)) tags.add(tag);
      return Array.from(tags);
    }

    function suggestBucket(book, buckets) {
      const priceList = (book.listPrice || "").match(/([0-9]+(?:\.[0-9]+)?)/);
      const msrp = priceList ? parseFloat(priceList[1]) : null;
      const year = (book.publishedDate || "").slice(0,4);
      const recent = year && parseInt(year) >= 2018;
      const rating = book.averageRating || 0;
      const strong = rating >= 4.2 || (book.ratingsCount || 0) > 10000;
      let idx = 1; // Blue $5
      if (strong || (msrp && msrp >= 27) || recent) idx = 2; // Purple $8
      if (strong && recent) idx = 4; // Black $10
      if (!recent && (book.ratingsCount || 0) < 100 && (!msrp || msrp < 18)) idx = 0; // Gold placeholder (blind-date may override)
      const safeIdx = Math.min(Math.max(idx, 0), buckets.length - 1);
      return buckets[safeIdx];
    }

    function suggestBlindDate(book, purchaseCost) {
      const author = (book.authors?.[0] || "").trim();
      const lesserKnown = !A_LIST_AUTHORS.has(author);
      const hasHook = (book.description || "").length > 160;
      const modestBuzz = (book.ratingsCount || 0) > 20 && (book.ratingsCount || 0) < 3000;
      const decentRating = (book.averageRating || 0) >= 3.6;
      const cheapBuy = (parseFloat(purchaseCost) || Infinity) <= 2.5;
      return lesserKnown && hasHook && decentRating && modestBuzz && cheapBuy;
    }

    function CameraScanner({ onDetected }) {
      const videoRef = useRef(null);
      const [supported, setSupported] = useState(false);
      const [active, setActive] = useState(false);
      const [error, setError] = useState("");

      useEffect(() => { setSupported('BarcodeDetector' in window); }, []);

      useEffect(() => {
        if (!active) return;
        let stream; let rafId; let detector;
        (async () => {
          setError("");
          try {
            if (!('BarcodeDetector' in window)) throw new Error('BarcodeDetector not supported');
            detector = new window.BarcodeDetector({ formats: ['ean_13','ean_8','upc_e','upc_a','isbn','code_128'] });
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
            if (videoRef.current) { videoRef.current.srcObject = stream; await videoRef.current.play(); }
            const scan = async () => {
              try {
                if (videoRef.current?.readyState === 4) {
                  const detections = await detector.detect(videoRef.current);
                  const code = detections?.[0]?.rawValue;
                  if (code) { onDetected(code); setActive(false); return; }
                }
              } catch {}
              rafId = requestAnimationFrame(scan);
            };
            scan();
          } catch (e) { setError(e.message || String(e)); setActive(false); }
        })();
        return () => { if (rafId) cancelAnimationFrame(rafId); if (stream) stream.getTracks().forEach(t => t.stop()); };
      }, [active, onDetected]);

      return (
        <div className="w-full">
          <div className="flex items-center gap-2">
            <button onClick={() => setActive(a => !a)} className={classNames("px-3 py-2 rounded-2xl shadow", active ? "bg-rose-600 text-white" : "bg-emerald-900 text-white")}>{active ? "Stop Scanner" : "Start Scanner"}</button>
            {!supported && <span className="text-sm text-rose-700">Barcode scanning not supported on this device/browser. Use manual ISBN/title lookup.</span>}
          </div>
          <div className="mt-3 rounded-2xl overflow-hidden shadow">
            <video ref={videoRef} className="w-full h-64 object-cover bg-black" muted playsInline />
          </div>
          {error && <p className="text-sm text-rose-700 mt-2">{error}</p>}
        </div>
      );
    }

    function App() {
      const [query, setQuery] = useState("");
      const [mode, setMode] = useState("isbn");
      const [loading, setLoading] = useState(false);
      const [results, setResults] = useState([]);
      const [current, setCurrent] = useState(null);
      const [inventory, setInventory] = useLocalStorage("bookish_inventory_v2", []);
      const [purchaseCost, setPurchaseCost] = useState("");
      const [condition, setCondition] = useState("");
      const [notes, setNotes] = useState("");

      const [buckets, setBuckets] = useLocalStorage("bookish_buckets_v2", DEFAULT_BUCKETS);
      const [blindDate, setBlindDate] = useLocalStorage("bookish_blinddate_settings_v1", { enableAutoFlag: true, bucketColor: "gold", price: 10 });

      const [cart, setCart] = useState([]);
      const [discountRules, setDiscountRules] = useLocalStorage("bookish_discounts_v1", { sameColorQty: 3, sameColorPercentOff: 10 });

      const [filter, setFilter] = useState("");
      const [view, setView] = useState("inventory");

      async function handleLookup(q) {
        setLoading(true);
        try {
          if (mode === "isbn") {
            const item = await fetchByISBN(q || query);
            setCurrent(item); setResults([]);
          } else {
            const items = await fetchByTitle(q || query);
            setResults(items); setCurrent(items[0] || null);
          }
        } finally { setLoading(false); }
      }

      function handleDetected(code) { setMode("isbn"); setQuery(code); handleLookup(code); }

      function addToInventory() {
        if (!current) return;
        const base = { ...current, id: uid(), addedAt: new Date().toISOString(), purchaseCost: purchaseCost || null, condition: condition || null, notes: notes || null };
        const tags = normalizeTags(current.categories || []);
        let bucket = suggestBucket(base, buckets);
        let targetPrice = bucket.price;
        const autoBlind = suggestBlindDate(base, purchaseCost);
        const blindDateCandidate = blindDate.enableAutoFlag ? autoBlind : false;
        if (blindDateCandidate) {
          const bdBucket = (buckets.find(b=>b.color===blindDate.bucketColor) || { price: blindDate.price, color: blindDate.bucketColor });
          bucket = bdBucket; targetPrice = bdBucket.price ?? targetPrice;
        }
        const entry = { ...base, tags, bucketColor: bucket.color, targetPrice, blindDateCandidate, sold: false, soldPrice: null };
        setInventory(prev => [entry, ...prev]);
        setPurchaseCost(""); setCondition(""); setNotes("");
      }

      function removeFromInventoryById(id) { setInventory(prev => prev.filter(it => it.id !== id)); }

      function exportCSV() { const csv = toCSV(inventory); saveFile(\`bookish_inventory_\${new Date().toISOString().slice(0,10)}.csv\`, csv); }

      async function handleCSVImport(evt) {
        const file = evt.target.files?.[0]; if (!file) return; const text = await file.text();
        const lines = text.split(/\r?\n/).filter(Boolean); if (lines.length < 2) return;
        const parseLine = (line) => { const out = []; let cur = ''; let inQ = false; for (let i=0;i<line.length;i++){ const ch=line[i]; if (ch==='"'){ if(inQ && line[i+1]==='"'){cur+='"'; i++;} else {inQ=!inQ;} } else if (ch===',' && !inQ){ out.push(cur); cur=''; } else { cur+=ch; } } out.push(cur); return out.map(s=>s.trim()); };
        const headers = lines[0].split(",").map(h=>h.trim()); const idx = k=>headers.indexOf(k); const val=(cols,k)=>cols[idx(k)]??''; const toArr=(cols,k)=>(val(cols,k)||'').split(';').map(s=>s.trim()).filter(Boolean);
        const rows = lines.slice(1).map(parseLine).map(cols => ({
          addedAt: val(cols,'addedAt')||new Date().toISOString(), id: val(cols,'id')||uid(), title: val(cols,'title'), authors: toArr(cols,'authors'),
          isbn10: val(cols,'isbn_10')||undefined, isbn13: val(cols,'isbn_13')||undefined, publisher: val(cols,'publisher'), publishedDate: val(cols,'publishedDate'),
          pageCount: val(cols,'pageCount')? Number(val(cols,'pageCount')): undefined, categories: toArr(cols,'categories'), tags: toArr(cols,'tags'),
          averageRating: val(cols,'averageRating')? Number(val(cols,'averageRating')): undefined, ratingsCount: val(cols,'ratingsCount')? Number(val(cols,'ratingsCount')): undefined,
          thumbnail: val(cols,'thumbnail')||undefined, listPrice: val(cols,'listPrice')||undefined, bucketColor: val(cols,'bucketColor')||undefined,
          targetPrice: val(cols,'targetPrice')? Number(val(cols,'targetPrice')): undefined, purchaseCost: val(cols,'purchaseCost')||undefined,
          condition: val(cols,'condition')||undefined, blindDateCandidate: (val(cols,'blindDateCandidate')||'').toLowerCase().startsWith('y'),
          sold: (val(cols,'sold')||'').toLowerCase().startsWith('y'), soldPrice: val(cols,'soldPrice')? Number(val(cols,'soldPrice')): undefined, notes: val(cols,'notes')||undefined,
        }));
        setInventory(rows); evt.target.value = '';
      }

      const filteredInv = inventory.filter(r => {
        const f = filter.trim().toLowerCase(); if (!f) return true;
        return ((r.title||"").toLowerCase().includes(f) || (r.authors||[]).join(" ").toLowerCase().includes(f) || (r.isbn13||"").includes(f) || (r.isbn10||"").includes(f) || (r.tags||[]).join(" ").toLowerCase().includes(f));
      });

      function addToCartByScan(code) { const cleaned = (code||"").replace(/[^0-9Xx]/g,""); const match = inventory.find(b => b.isbn13 === cleaned || b.isbn10 === cleaned); if (match) addToCart(match); }
      function addToCart(item) { setCart(prev => [...prev, { id: item.id, title: item.title, bucketColor: item.bucketColor, price: item.targetPrice }]); }
      function removeFromCart(idx) { setCart(prev => prev.filter((_,i) => i !== idx)); }
      function clearCart() { setCart([]); }
      function computeCartTotals() {
        const subtotal = cart.reduce((s, it) => s + (Number(it.price)||0), 0);
        const byColor = cart.reduce((acc, it) => { acc[it.bucketColor] = (acc[it.bucketColor]||0) + 1; return acc; }, {});
        let discount = 0;
        for (const color of Object.keys(byColor)) {
          if (byColor[color] >= (discountRules.sameColorQty || 999)) {
            const eligible = cart.filter(it => it.bucketColor === color);
            const sum = eligible.reduce((s, it) => s + (Number(it.price)||0), 0);
            discount += sum * ((discountRules.sameColorPercentOff||0)/100);
          }
        }
        discount = Math.round(discount*100)/100; const total = Math.max(0, Math.round((subtotal - discount)*100)/100);
        return { subtotal, discount, total };
      }
      function finalizeSale() { const ids = cart.map(c => c.id); setInventory(prev => prev.map(it => ids.includes(it.id) ? { ...it, sold: true, soldPrice: it.targetPrice } : it)); clearCart(); }

      return (
        <div className="min-h-screen text-slate-900 p-6">
          <div className="max-w-7xl mx-auto">
            <header className="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-4">
              <div>
                <h1 className="text-3xl font-bold">üìö Bookish Inventory & Checkout</h1>
                <p className="text-sm text-slate-600 mt-1">Scan ISBNs or search by title. Auto‚Äëcategorizes, suggests pricing buckets (forest‚Äëgreen/gold/black scheme), flags Blind‚ÄëDate candidates, and supports checkout with volume discounts.</p>
              </div>
              <nav className="flex gap-2">
                <button onClick={()=>setView("inventory")} className={classNames("px-3 py-2 rounded-2xl shadow", view==='inventory'?"bg-emerald-900 text-white":"bg-white")}>Inventory</button>
                <button onClick={()=>setView("checkout")} className={classNames("px-3 py-2 rounded-2xl shadow", view==='checkout'?"bg-emerald-900 text-white":"bg-white")}>Checkout</button>
                <button onClick={()=>setView("settings")} className={classNames("px-3 py-2 rounded-2xl shadow", view==='settings'?"bg-emerald-900 text-white":"bg-white")}>Settings</button>
              </nav>
            </header>

            {view === 'inventory' && (
              <div className="grid md:grid-cols-2 gap-6">
                <section className="space-y-4">
                  <div className="p-4 bg-white rounded-2xl shadow">
                    <h2 className="text-lg font-semibold mb-3">Scan barcode</h2>
                    <CameraScanner onDetected={handleDetected} />
                    <p className="text-xs text-slate-500 mt-2">Note: Camera requires HTTPS (or localhost). On plain LAN http://IP:3000, scanning may be blocked on some phones; manual ISBN/title lookup works regardless.</p>
                  </div>

                  <div className="p-4 bg-white rounded-2xl shadow">
                    <h2 className="text-lg font-semibold">Manual lookup</h2>
                    <div className="mt-3 flex gap-2">
                      <select value={mode} onChange={(e) => setMode(e.target.value)} className="rounded-2xl border px-3 py-2">
                        <option value="isbn">ISBN</option>
                        <option value="title">Title</option>
                      </select>
                      <input value={query} onChange={(e)=> setQuery(e.target.value)} placeholder={mode === 'isbn' ? 'e.g., 9780385547345' : 'e.g., The Girl with the Dragon Tattoo'} className="flex-1 rounded-2xl border px-3 py-2" />
                      <button onClick={()=>handleLookup()} className="px-4 py-2 rounded-2xl bg-emerald-900 text-white shadow">Look up</button>
                    </div>
                    {loading && <p className="text-sm text-slate-600 mt-2">Looking up‚Ä¶</p>}

                    {mode === 'title' && results?.length > 1 && (
                      <div className="mt-3 max-h-56 overflow-auto border rounded-2xl">
                        {results.map((r, i) => (
                          <button key={i} onClick={() => setCurrent(r)} className={classNames("w-full text-left p-3 border-b last:border-b-0 hover:bg-slate-50", current?.title === r.title ? 'bg-slate-100' : '')}>
                            <div className="font-medium">{r.title}</div>
                            <div className="text-sm text-slate-600">{(r.authors || []).join(', ')}</div>
                            <div className="text-xs text-slate-500">{r.publishedDate} {(r.isbn13||r.isbn10) ? \`‚Ä¢ \${r.isbn13 || r.isbn10}\` : ''}</div>
                          </button>
                        ))}
                      </div>
                    )}
                  </div>

                  <SelectedBookPanel current={current} purchaseCost={purchaseCost} setPurchaseCost={setPurchaseCost} condition={condition} setCondition={setCondition} notes={notes} setNotes={setNotes} addToInventory={addToInventory} />
                </section>

                <section className="p-4 bg-white rounded-2xl shadow">
                  <div className="flex items-center justify-between">
                    <h2 className="text-lg font-semibold">Your inventory ({inventory.length})</h2>
                    <div className="flex items-center gap-2">
                      <input value={filter} onChange={(e)=>setFilter(e.target.value)} placeholder="Filter by title/author/ISBN/tag" className="border rounded-2xl px-3 py-2" />
                      <input type="file" id="csvFile" accept=".csv" className="hidden" onChange={handleCSVImport} />
                      <button onClick={()=>document.getElementById('csvFile').click()} className="px-3 py-2 rounded-2xl bg-white border">Import CSV</button>
                      <button onClick={exportCSV} className="px-3 py-2 rounded-2xl bg-emerald-900 text-white shadow">Export CSV</button>
                      <button onClick={()=>setInventory([])} className="px-3 py-2 rounded-2xl bg-rose-600 text-white shadow">Clear All</button>
                    </div>
                  </div>

                  <div className="mt-3 border rounded-2xl overflow-hidden max-h-[65vh] overflow-y-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-100 sticky top-0">
                        <tr>
                          <th className="p-2 text-left">Title</th>
                          <th className="p-2 text-left">Author(s)</th>
                          <th className="p-2">Tags</th>
                          <th className="p-2">Pace</th>
                          <th className="p-2">Avg ‚òÖ</th>
                          <th className="p-2">Bucket</th>
                          <th className="p-2">Price</th>
                          <th className="p-2">Cost</th>
                          <th className="p-2">Added</th>
                          <th className="p-2"></th>
                        </tr>
                      </thead>
                      <tbody>
                        {filteredInv.map((r) => {
                          const est = estimateReadingTime(r.pageCount);
                          return (
                            <tr key={r.id} className="border-b last:border-b-0 hover:bg-slate-50">
                              <td className="p-2">
                                <div className="font-medium">{r.title}</div>
                                <div className="text-xs text-slate-500">{r.publisher} ‚Ä¢ {r.publishedDate}</div>
                              </td>
                              <td className="p-2">{(r.authors || []).join(', ')}</td>
                              <td className="p-2 text-center">{(r.tags||[]).join(', ')}</td>
                              <td className="p-2 text-center">{est.pace}</td>
                              <td className="p-2 text-center">{r.averageRating ?? '‚Äî'}</td>
                              <td className="p-2 text-center">
                                <span className={classNames("px-2 py-1 rounded-xl text-xs border", bucketChipClass(r.bucketColor))}>{r.bucketColor || '‚Äî'}</span>
                                {r.blindDateCandidate && <span className="ml-2 text-[10px] px-2 py-1 rounded-xl bg-yellow-100 text-yellow-800 border border-yellow-300">Blind‚Äëdate ‚≠ê</span>}
                              </td>
                              <td className="p-2 text-center">${'{'}r.targetPrice{'}'}</td>
                              <td className="p-2 text-center">{r.purchaseCost ? `$${'{'}r.purchaseCost{'}'}` : '‚Äî'}</td>
                              <td className="p-2 text-center">{new Date(r.addedAt).toLocaleDateString()}</td>
                              <td className="p-2 text-right flex gap-2 justify-end">
                                <button onClick={()=>addToCart(r)} className="px-3 py-1 rounded-xl bg-emerald-600 text-white">Add to Cart</button>
                                <button onClick={()=>removeFromInventoryById(r.id)} className="px-3 py-1 rounded-xl bg-slate-200 hover:bg-slate-300">Remove</button>
                              </td>
                            </tr>
                          );
                        })}
                        {filteredInv.length === 0 && (
                          <tr>
                            <td colSpan={10} className="p-6 text-center text-slate-500">No books yet. Scan or look up to add.</td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </section>
              </div>
            )}

            {view === 'checkout' && (
              <div className="grid md:grid-cols-2 gap-6">
                <section className="p-4 bg-white rounded-2xl shadow">
                  <h2 className="text-lg font-semibold mb-3">Checkout scanner</h2>
                  <CameraScanner onDetected={addToCartByScan} />
                  <div className="mt-3"><p className="text-sm text-slate-600">Tip: You can also tap "Add to Cart" on any inventory row.</p></div>
                </section>
                <section className="p-4 bg-white rounded-2xl shadow">
                  <h2 className="text-lg font-semibold mb-3">Cart</h2>
                  <div className="border rounded-2xl overflow-hidden max-h-[55vh] overflow-y-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-slate-100 sticky top-0"><tr><th className="p-2 text-left">Title</th><th className="p-2">Bucket</th><th className="p-2">Price</th><th className="p-2"></th></tr></thead>
                      <tbody>
                        {cart.map((c, i) => (
                          <tr key={i} className="border-b last:border-b-0">
                            <td className="p-2">{c.title}</td>
                            <td className="p-2 text-center"><span className={classNames("px-2 py-1 rounded-xl text-xs border", bucketChipClass(c.bucketColor))}>{c.bucketColor}</span></td>
                            <td className="p-2 text-center">${'{'}c.price{'}'}</td>
                            <td className="p-2 text-right"><button onClick={()=>removeFromCart(i)} className="px-2 py-1 rounded-xl bg-slate-200">Remove</button></td>
                          </tr>
                        ))}
                        {cart.length === 0 && (<tr><td colSpan={4} className="p-6 text-center text-slate-500">Cart is empty.</td></tr>)}
                      </tbody>
                    </table>
                  </div>
                  <CartTotals cart={cart} discountRules={discountRules} computeCartTotals={computeCartTotals} />
                  <div className="mt-3 flex gap-2 justify-end">
                    <button onClick={clearCart} className="px-3 py-2 rounded-2xl bg-slate-200">Clear</button>
                    <button onClick={()=>finalizeSale()} className="px-3 py-2 rounded-2xl bg-emerald-600 text-white">Finalize Sale</button>
                  </div>
                </section>
              </div>
            )}

            {view === 'settings' && (
              <div className="grid md:grid-cols-2 gap-6">
                <section className="p-4 bg-white rounded-2xl shadow">
                  <h2 className="text-lg font-semibold">Pricing buckets</h2>
                  <p className="text-sm text-slate-600">Configured for your forest‚Äëgreen / gold / black palette. Gold is reserved for Blind‚ÄëDate books by default.</p>
                  <BucketEditor buckets={buckets} setBuckets={setBuckets} />
                </section>
                <section className="p-4 bg-white rounded-2xl shadow space-y-3">
                  <h2 className="text-lg font-semibold">Blind‚ÄëDate settings</h2>
                  <label className="text-sm flex items-center gap-2"><input type="checkbox" checked={blindDate.enableAutoFlag} onChange={e=>setBlindDate({...blindDate, enableAutoFlag: e.target.checked})} /> Auto‚Äëflag candidates</label>
                  <div className="grid grid-cols-3 gap-3">
                    <label className="text-sm">Bucket color
                      <input value={blindDate.bucketColor} onChange={e=>setBlindDate({...blindDate, bucketColor: e.target.value})} className="mt-1 w-full border rounded-xl px-3 py-2" />
                    </label>
                    <label className="text-sm">Blind‚ÄëDate price
                      <input type="number" value={blindDate.price} onChange={e=>setBlindDate({...blindDate, price: Number(e.target.value)})} className="mt-1 w-full border rounded-xl px-3 py-2" />
                    </label>
                    <div className="self-end"><span className={classNames("px-2 py-1 rounded-xl border text-xs", bucketChipClass(blindDate.bucketColor))}>preview</span></div>
                  </div>
                  <p className="text-xs text-slate-500">Heuristic prefers lesser‚Äëknown authors with intriguing descriptions and decent ratings that you acquired cheaply.</p>
                </section>
              </div>
            )}

            <footer className="mt-6 text-xs text-slate-500">
              <p>Mobile tip: For barcode scanning on phone, open this over <b>HTTPS</b> (GitHub Pages or similar) or use <b>localhost</b>. On plain LAN http://IP:3000, Chrome may block camera access.</p>
            </footer>
          </div>
        </div>
      );
    }

    function SelectedBookPanel({ current, purchaseCost, setPurchaseCost, condition, setCondition, notes, setNotes, addToInventory }) {
      return (
        <div className="p-4 bg-white rounded-2xl shadow">
          <h2 className="text-lg font-semibold">Selected book</h2>
          {!current && <p className="text-sm text-slate-600 mt-2">No book selected yet. Scan a barcode or search above.</p>}
          {current && (
            <div className="mt-3 grid grid-cols-3 gap-4">
              <div className="col-span-1">
                {current.thumbnail ? (
                  <img src={current.thumbnail} alt={current.title} className="w-full rounded-xl shadow" />
                ) : (
                  <div className="w-full aspect-[2/3] bg-slate-100 rounded-xl grid place-items-center text-slate-400">No cover</div>
                )}
              </div>
              <div className="col-span-2 space-y-1">
                <div className="text-xl font-semibold">{current.title}</div>
                <div className="text-slate-700">{(current.authors || []).join(', ')}</div>
                <div className="text-sm text-slate-600">{current.publisher} ‚Ä¢ {current.publishedDate}</div>
                <div className="text-sm text-slate-600">ISBN-13: {current.isbn13 || '‚Äî'} ‚Ä¢ ISBN-10: {current.isbn10 || '‚Äî'}</div>
                <div className="text-sm text-slate-600">Pages: {current.pageCount || '‚Äî'}</div>
                <div className="text-sm text-slate-600">Categories: {(current.categories || []).join(', ') || '‚Äî'}</div>
                <div className="text-sm text-slate-600">Avg rating: {current.averageRating ?? '‚Äî'} ({current.ratingsCount ?? 0})</div>
                <div className="text-sm text-slate-600">List price: {current.listPrice || '‚Äî'}</div>
                <Derived current={current} />

                <div className="pt-2 grid grid-cols-3 gap-2">
                  <input value={purchaseCost} onChange={(e)=>setPurchaseCost(e.target.value)} placeholder="Purchase cost (e.g., 2.29)" className="border rounded-xl px-3 py-2" />
                  <input value={condition} onChange={(e)=>setCondition(e.target.value)} placeholder="Condition (e.g., Very Good)" className="border rounded-xl px-3 py-2" />
                  <input value={notes} onChange={(e)=>setNotes(e.target.value)} placeholder="Notes (shelf, set, etc.)" className="border rounded-xl px-3 py-2" />
                </div>

                <div className="flex items-center gap-3 pt-2">
                  <button onClick={addToInventory} className="px-4 py-2 rounded-2xl bg-emerald-900 text-white shadow">Add to inventory</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function Derived({ current }) {
      const est = estimateReadingTime(current.pageCount);
      return (
        <div className="mt-1 text-sm">
          <div className="inline-flex items-center gap-2 bg-slate-100 rounded-xl px-2 py-1 mr-2">Pace: <span className="font-medium">{est.pace}</span></div>
          {est.hours && (<div className="inline-flex items-center gap-2 bg-slate-100 rounded-xl px-2 py-1">Est. reading time: <span className="font-medium">{est.hours} hrs</span></div>)}
        </div>
      );
    }

    function BucketEditor({ buckets, setBuckets }) {
      const [local, setLocal] = useState(buckets);
      function update(i, key, val) { setLocal(prev => prev.map((b, idx) => idx===i ? { ...b, [key]: val } : b)); }
      function add() { setLocal(prev => [...prev, { color: "new", label: "New", price: 12 }]); }
      function save() { setBuckets(local); }
      function reset() { setLocal(DEFAULT_BUCKETS); }
      return (
        <div className="mt-3">
          <div className="space-y-2">
            {local.map((b, i) => (
              <div key={i} className="grid grid-cols-4 gap-2 items-center">
                <input value={b.color} onChange={e=>update(i,'color',e.target.value)} className="border rounded-xl px-3 py-2" placeholder="color key (e.g., red)" />
                <input value={b.label} onChange={e=>update(i,'label',e.target.value)} className="border rounded-xl px-3 py-2" placeholder="Label (Red)" />
                <input type="number" value={b.price} onChange={e=>update(i,'price', Number(e.target.value))} className="border rounded-xl px-3 py-2" placeholder="$" />
                <span className={classNames("justify-self-end px-2 py-1 rounded-xl border text-xs", bucketChipClass(b.color))}>preview</span>
              </div>
            ))}
          </div>
          <div className="flex gap-2 mt-3">
            <button onClick={add} className="px-3 py-2 rounded-2xl bg-slate-200">Add bucket</button>
            <button onClick={reset} className="px-3 py-2 rounded-2xl bg-slate-200">Reset default</button>
            <button onClick={save} className="px-3 py-2 rounded-2xl bg-emerald-900 text-white">Save</button>
          </div>
        </div>
      );
    }

    function CartTotals({ cart, discountRules, computeCartTotals }) {
      const { subtotal, discount, total } = computeCartTotals();
      const counts = cart.reduce((acc, it) => { acc[it.bucketColor] = (acc[it.bucketColor]||0)+1; return acc; }, {});
      return (
        <div className="mt-3 p-3 bg-slate-50 rounded-2xl border">
          <div className="flex flex-wrap gap-2 text-sm mb-2">
            {Object.keys(counts).map(c => (
              <span key={c} className={classNames("px-2 py-1 rounded-xl border", bucketChipClass(c))}>{c}: {counts[c]}</span>
            ))}
          </div>
          <div className="text-sm space-y-1">
            <div className="flex justify-between"><span>Subtotal</span><span>${'{'}subtotal.toFixed(2){'}'}</span></div>
            <div className="flex justify-between"><span>Discount</span><span>- ${'{'}discount.toFixed(2){'}'}</span></div>
            <div className="flex justify-between font-semibold text-lg"><span>Total</span><span>${'{'}total.toFixed(2){'}'}</span></div>
          </div>
          <p className="text-xs text-slate-500 mt-2">Rule: buy {discountRules.sameColorQty}+ of the same color ‚Üí {discountRules.sameColorPercentOff}% off those items.</p>
        </div>
      );
    }

    function bucketChipClass(color) {
      switch ((color||'').toLowerCase()) {
        case 'red': return 'bg-red-100 text-red-800 border-red-300';
        case 'blue': return 'bg-blue-100 text-blue-800 border-blue-300';
        case 'purple': return 'bg-purple-100 text-purple-800 border-purple-300';
        case 'black': return 'bg-black text-white border-black';
        case 'green': return 'bg-emerald-100 text-emerald-800 border-emerald-300';
        case 'gold': return 'bg-yellow-100 text-yellow-800 border-yellow-300';
        default: return 'bg-slate-100 text-slate-800 border-slate-300';
      }
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
